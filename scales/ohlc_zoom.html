<!DOCTYPE html>
<html>
  <head>
    <title>@aodin/charts - OHLCV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
body {
  font-family: sans-serif;
  color: white;
  background-color: black;
}
#title {
  display: flex;
  flex: columns;
  align-items: center;
  justify-content: start;
}
#title h1 {
  font-weight: normal;
  margin: 10px 20px 10px;
}
#hud p {
  margin-bottom: 5px;
}
#hud div {
  height: 20px;
}
@media (max-width: 600px) {
  #title h1 {
    font-size: 24px;
    margin: 10px;
  }
  text {
    font-size: 10px !important;
  }
  #hud {
    font-size: 10px !important;
  }
}
#chart .y .domain {
  display: none;
}
#chart .x .domain {
  display: none;
}
    </style>
  </head>
  <body>
    <div id="title">
      <h1>OHLC</h1>
      <button id="log">Log</button>
      <button id="linear">Linear</button>
      <button id="zoom">Zoom</button>
      <button id="original">Original</button>
    </div>
    <div>
      <svg id="chart" width="1000" height="500"></svg>
    </div>
    <div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="text/javascript">
const monthly = [{"date":"2019-07-31","open":11479.1107326441,"high":13174.6197274519,"low":9082.4464903184,"close":10087.9864275681,"volume":157186286292},{"date":"2019-08-31","open":10090.1827777952,"high":12300.9262396266,"low":9340.8631387948,"close":9601.6307096956,"volume":158157629499},{"date":"2019-09-30","open":9599.6775544528,"high":10933.2958025065,"low":7739.9915156719,"close":8311.7640386527,"volume":110637830611},{"date":"2019-10-31","open":8306.5043389761,"high":10449.6695372546,"low":7347.4289649109,"close":9154.2489384754,"volume":123804054842},{"date":"2019-11-30","open":9163.4973860031,"high":9540.2960697114,"low":6526.9928300613,"close":7553.3508959335,"volume":116762894555},{"date":"2019-12-31","open":7559.7815750682,"high":7762.2296489293,"low":6449.4899053741,"close":7191.3219443545,"volume":101267014426},{"date":"2020-01-31","open":7175.0426420714,"high":9562.2620907039,"low":6866.3672515933,"close":9335.9307699334,"volume":152057023976},{"date":"2020-02-29","open":9340.7741431783,"high":10505.8140572507,"low":8434.1250392598,"close":8539.0436293357,"volume":211155791888},{"date":"2020-03-31","open":8529.0535147328,"high":9209.3453099463,"low":3939.2253967686,"close":6423.8076004769,"volume":233892066018},{"date":"2020-04-30","open":6423.8112666855,"high":9453.6069503671,"low":6164.2087822806,"close":8632.1900986313,"volume":173602296457},{"date":"2020-05-31","open":8630.1142828875,"high":10057.8641473578,"low":8142.9537045077,"close":9453.0048420111,"volume":221080954509},{"date":"2020-06-30","open":9447.8230465656,"high":10371.7644782771,"low":8840.9932572976,"close":9135.2828596096,"volume":133820642309},{"date":"2020-07-31","open":9136.2951758674,"high":11451.6558713428,"low":8937.1888439644,"close":11349.2088918775,"volume":117281045159},{"date":"2020-08-31","open":11350.3449624851,"high":12469.3393509508,"low":10656.2686824124,"close":11655.861582381,"volume":172287188853},{"date":"2020-09-30","open":11656.3588292651,"high":12056.7697277763,"low":9882.9650544361,"close":10778.3673567693,"volume":136330289752},{"date":"2020-10-31","open":10783.1508152139,"high":14055.0182527341,"low":10396.4603658604,"close":13805.5438890909,"volume":122537404268},{"date":"2020-11-30","open":13793.7780078518,"high":19851.7285697355,"low":13235.2760115813,"close":19694.6869135342,"volume":220292916120},{"date":"2020-12-31","open":19692.8715903833,"high":29300.7342462754,"low":17593.8030312452,"close":28967.3861893205,"volume":297023612970},{"date":"2021-01-31","open":28943.5364966834,"high":41960.0598677275,"low":28081.7550371234,"close":33135.2390394512,"volume":657002325926},{"date":"2021-02-28","open":33120.6805387173,"high":58352.5983504023,"low":32390.2348554928,"close":45201.6239257671,"volume":693515964327},{"date":"2021-03-31","open":45200.0727705014,"high":61727.9592221608,"low":45038.3607559127,"close":58749.0849388158,"volume":717513433330},{"date":"2021-04-30","open":58763.3764244681,"high":64828.5551266111,"low":47088.3224753972,"close":57790.9170107794,"volume":895087489855},{"date":"2021-05-31","open":57764.5289941682,"high":59575.0505405995,"low":30239.9597778785,"close":37280.366049434,"volume":1022458560921},{"date":"2021-06-30","open":37277.9002842319,"high":41301.1038989204,"low":28879.1196571886,"close":35055.7016040317,"volume":624646015451},{"date":"2021-07-31","open":35062.6713148942,"high":42243.8300857975,"low":29323.8280606704,"close":41476.786988074,"volume":381351959282},{"date":"2021-08-31","open":41552.4191338994,"high":50470.5597721982,"low":37403.3102959187,"close":47135.195786732,"volume":485167576747},{"date":"2021-09-30","open":47120.980211706,"high":52888.0119745879,"low":39690.5785810198,"close":43811.0329566069,"volume":514172439815},{"date":"2021-10-31","open":43806.2532473967,"high":67049.763989568,"low":43311.9038146077,"close":61349.6401428718,"volume":580553849518},{"date":"2021-11-30","open":61350.1401671621,"high":68982.5203041007,"low":53540.8002921776,"close":56989.9216974795,"volume":523985511492},{"date":"2021-12-31","open":57010.1851432362,"high":59066.1057911264,"low":42471.3720113286,"close":46195.3332119362,"volume":490371064370},{"date":"2022-01-31","open":46187.4618396572,"high":47956.5608297318,"low":33058.0117281999,"close":38506.030202382,"volume":387080053567},{"date":"2022-02-28","open":38509.7998506495,"high":45787.7246405815,"low":34367.2839743581,"close":43205.5850119976,"volume":300104983793},{"date":"2022-03-31","open":43199.0162181411,"high":48195.3868636025,"low":37175.7740104515,"close":45512.7446354782,"volume":385915286475},{"date":"2022-04-30","open":45518.8891960251,"high":47409.941301172,"low":37632.8824804292,"close":37643.3035677405,"volume":393307911961},{"date":"2022-05-31","open":37646.0400897948,"high":39961.7532425614,"low":25437.0653734583,"close":31778.3762079844,"volume":451193734122},{"date":"2022-06-30","open":31781.7828027924,"high":31960.132303643,"low":17610.6639162709,"close":19912.3137782117,"volume":388410162185},{"date":"2022-07-31","open":19904.0407467651,"high":24607.7795548724,"low":18779.3409016176,"close":23306.4606271024,"volume":372668074341},{"date":"2022-08-31","open":23301.9215721013,"high":25190.5314878336,"low":19534.7117004553,"close":20050.6621764638,"volume":446481526878},{"date":"2022-09-30","open":20049.5170085278,"high":22715.9431949442,"low":18201.7578850469,"close":19424.5482352033,"volume":533246037014},{"date":"2022-10-31","open":19424.1441195827,"high":21064.0130620561,"low":18229.6836870867,"close":20493.3614474113,"volume":402981569708},{"date":"2022-11-30","open":20493.3605341996,"high":21469.8368264487,"low":15496.6404102282,"close":17163.7647501793,"volume":432774313580},{"date":"2022-12-31","open":17165.3296245616,"high":18351.8973763742,"low":16325.0446116525,"close":16531.3346842968,"volume":260576246475},{"date":"2023-01-31","open":16532.9155954813,"high":23938.6606063899,"low":16495.4266555823,"close":23125.9889519806,"volume":394618503918},{"date":"2023-02-28","open":23130.1881749452,"high":25235.1853985562,"low":21432.7108422969,"close":23134.7587827078,"volume":469288735180},{"date":"2023-03-31","open":23141.7122902601,"high":29162.5554809284,"low":19598.4417678182,"close":28473.7951454125,"volume":486706422690},{"date":"2023-04-30","open":28470.1611051552,"high":30994.7393268623,"low":27036.2023001431,"close":29248.2145819499,"volume":211230848487},{"date":"2023-05-31","open":29259.3909012484,"high":29818.4224977038,"low":25885.1732977883,"close":27220.7370328436,"volume":196476146371},{"date":"2023-06-30","open":27217.7887918695,"high":31386.0393550371,"low":24816.2308479218,"close":30469.3171315972,"volume":222540445171},{"date":"2023-07-31","open":30468.7059749304,"high":31820.5256439331,"low":28927.3978460039,"close":29235.9767250079,"volume":165071690351},{"date":"2023-08-31","open":29229.8225430921,"high":30175.2243689463,"low":25252.6018152517,"close":25931.4068204818,"volume":189308534915},{"date":"2023-09-30","open":25932.490081351,"high":27490.4961344281,"low":24924.0029657602,"close":26965.7043840752,"volume":142646289408},{"date":"2023-10-31","open":26962.4284888434,"high":35134.3996988474,"low":26546.6219066675,"close":34660.7620325507,"volume":231139614067},{"date":"2023-11-30","open":34662.6674055336,"high":38419.2214482234,"low":34100.1362481856,"close":37729.1566516014,"volume":252122207037},{"date":"2023-12-31","open":37728.5845440622,"high":44717.0946852135,"low":37631.0824737393,"close":42282.5140312542,"volume":343134441372},{"date":"2024-01-31","open":42282.222862654,"high":48927.5637732079,"low":38511.7918805714,"close":42563.4558139687,"volume":553890023416},{"date":"2024-02-29","open":42555.3750737325,"high":63993.685697298,"low":41875.6848448581,"close":61175.0343655316,"volume":900807668404},{"date":"2024-03-31","open":61179.4291167496,"high":73797.3460644724,"low":60036.7969494619,"close":71310.3411604014,"volume":1331734215618},{"date":"2024-04-30","open":71301.0315545775,"high":72713.1483396711,"low":57407.1084198102,"close":60630.2041421363,"volume":809713745912},{"date":"2024-05-31","open":60626.5855481158,"high":71942.22043093,"low":56567.3485996336,"close":67477.3573973235,"volume":628751589578},{"date":"2024-06-30","open":67477.2153564078,"high":71923.5859950591,"low":58619.6661383516,"close":62707.4239897434,"volume":431632629166},{"date":"2024-07-08","open":62694.88082846,"high":63796.3181534763,"low":53802.8689506418,"close":55534.4061011695,"volume":142120942960}];
  
const weekly = [
  {"date":"2023-05-28","open":0.025465955,"high":0.0297871174,"low":0.0149836855,"close":0.0161828248,"volume":1045886},
  {"date":"2023-06-04","open":0.0161828248,"high":0.0199495389,"low":0.0126423251,"close":0.0181763135,"volume":390276},
  {"date":"2023-06-11","open":0.0181763135,"high":0.0181596174,"low":0.0108559639,"close":0.0126689321,"volume":236115},
  {"date":"2023-06-18","open":0.0126689321,"high":0.0151024933,"low":0.0100968547,"close":0.0131235752,"volume":128766},
  {"date":"2023-06-25","open":0.0131235752,"high":0.015060985,"low":0.0121886475,"close":0.0130428546,"volume":205372},
  {"date":"2023-07-02","open":0.0130428546,"high":0.0146495811,"low":0.0117210673,"close":0.0132555825,"volume":232874},
  {"date":"2023-07-09","open":0.0132555825,"high":0.0221121749,"low":0.013125131,"close":0.0198187115,"volume":182984},
  {"date":"2023-07-16","open":0.0198187115,"high":0.026055868,"low":0.0191164799,"close":0.0220034123,"volume":121797},
  {"date":"2023-07-23","open":0.0220034123,"high":0.0228542549,"low":0.019169836,"close":0.0193539882,"volume":87416},{"date":"2023-07-30","open":0.0193539882,"high":0.0214878846,"low":0.017738084,"close":0.0197149681,"volume":65612},{"date":"2023-08-06","open":0.0197149681,"high":0.0219252682,"low":0.0064683972,"close":0.0104187498,"volume":51606},{"date":"2023-08-13","open":0.0104187498,"high":0.0113706547,"low":0.0078913014,"close":0.0102502647,"volume":27349},{"date":"2023-08-20","open":0.0102502647,"high":0.0101873312,"low":0.0076857058,"close":0.0077862235,"volume":20707},{"date":"2023-08-27","open":0.0077862235,"high":0.0078738064,"low":0.0054987916,"close":0.0070841026,"volume":13871},{"date":"2023-09-03","open":0.0070841026,"high":0.0107638696,"low":0.0068070581,"close":0.0082504698,"volume":19908},{"date":"2023-09-10","open":0.0082504698,"high":0.008391677,"low":0.0069465149,"close":0.0069478953,"volume":4583},{"date":"2023-09-17","open":0.0069478953,"high":0.00877254,"low":0.006474928,"close":0.0079247588,"volume":1682},{"date":"2023-09-24","open":0.0079247588,"high":0.0092172369,"low":0.0077274944,"close":0.0079388545,"volume":3348},{"date":"2023-10-01","open":0.0079388545,"high":0.0090062038,"low":0.0076093963,"close":0.0090062038,"volume":1947},{"date":"2023-10-08","open":0.0090062038,"high":0.0089116284,"low":0.0076679383,"close":0.0079319173,"volume":1210},{"date":"2023-10-15","open":0.0079319173,"high":0.0078998141,"low":0.0069084893,"close":0.0069466919,"volume":579},{"date":"2023-10-22","open":0.0069466919,"high":0.0459567568,"low":0.0068192289,"close":0.044951926,"volume":651},{"date":"2023-10-29","open":0.01236583,"high":0.017795107,"low":0.0112833625,"close":0.0127145183,"volume":1737},{"date":"2023-11-05","open":0.0127145183,"high":0.0161694187,"low":0.0122278262,"close":0.0151586001,"volume":1825},{"date":"2023-11-12","open":0.0151586001,"high":0.0372057933,"low":0.0129175527,"close":0.0313561872,"volume":1222},{"date":"2023-11-19","open":0.0313561872,"high":0.032676948,"low":0.0259269328,"close":0.0285789831,"volume":553},{"date":"2023-11-26","open":0.0285789831,"high":0.0318281084,"low":0.0253085744,"close":0.0318281084,"volume":681},{"date":"2023-12-03","open":0.0318281084,"high":0.0340721463,"low":0.0249301587,"close":0.0282301198,"volume":725},{"date":"2023-12-10","open":0.0282301198,"high":0.0287079214,"low":0.021379766,"close":0.0257960082,"volume":507},{"date":"2023-12-17","open":0.0257960082,"high":0.0271030562,"low":0.0232972392,"close":0.0257825855,"volume":200},{"date":"2023-12-24","open":0.0257825855,"high":0.0390553203,"low":0.0249552928,"close":0.037896809,"volume":554},{"date":"2023-12-31","open":0.037896809,"high":0.0415186209,"low":0.0327247752,"close":0.0350300574,"volume":936},{"date":"2024-01-07","open":0.0350300574,"high":0.0716878813,"low":0.0327271834,"close":0.0650500882,"volume":4466},{"date":"2024-01-14","open":0.0650500882,"high":0.1480656395,"low":0.0641724124,"close":0.1262862386,"volume":18214},{"date":"2024-01-21","open":0.1262862386,"high":0.2778084279,"low":0.10501538,"close":0.2201230522,"volume":30019},{"date":"2024-01-28","open":0.2201230522,"high":0.2996798732,"low":0.1316915845,"close":0.285315975,"volume":15360},{"date":"2024-02-04","open":0.285315975,"high":0.2986945366,"low":0.2021274501,"close":0.2106045807,"volume":10087},{"date":"2024-02-11","open":0.2106045807,"high":0.2444259871,"low":0.1846758833,"close":0.1873556591,"volume":5806},{"date":"2024-02-18","open":0.1873556591,"high":0.2132958619,"low":0.1550243431,"close":0.1795921185,"volume":3632},{"date":"2024-02-25","open":0.1795921185,"high":0.1799428778,"low":0.139017686,"close":0.1603053827,"volume":2060},{"date":"2024-03-03","open":0.1603053827,"high":0.2193740043,"low":0.1536930265,"close":0.1732607478,"volume":3677},{"date":"2024-03-10","open":0.1732607478,"high":0.2439152186,"low":0.1318559073,"close":0.1853010719,"volume":8528},{"date":"2024-03-17","open":0.1853010719,"high":0.193844473,"low":0.0717102411,"close":0.0971617395,"volume":8126},{"date":"2024-03-24","open":0.0971617395,"high":0.0971617395,"low":0.0110498058,"close":0.0118490523,"volume":1828},{"date":"2024-03-31","open":0.0118490523,"high":0.0123865676,"low":0.0099955293,"close":0.0101376778,"volume":1793},{"date":"2024-04-07","open":0.0101376778,"high":0.0109246809,"low":0.0088896914,"close":0.0098703926,"volume":1451},{"date":"2024-04-14","open":0.0098703926,"high":0.0109469071,"low":0.0067606128,"close":0.0082536302,"volume":2277},{"date":"2024-04-21","open":0.0082536302,"high":0.0120217344,"low":0.0074716601,"close":0.0089067796,"volume":2014},{"date":"2024-04-28","open":0.1008660314,"high":0.1116019199,"low":0.0079786595,"close":0.0088602768,"volume":1391},{"date":"2024-05-05","open":0.0088602768,"high":0.0094587766,"low":0.0073771165,"close":0.0092061267,"volume":788},{"date":"2024-05-12","open":0.0092061267,"high":0.1230020668,"low":0.0082485885,"close":0.0950118933,"volume":3891},{"date":"2024-05-19","open":0.0950118933,"high":0.1659867491,"low":0.088877046,"close":0.0931912015,"volume":4316},{"date":"2024-05-26","open":0.0931912015,"high":0.1020565387,"low":0.0691130506,"close":0.0701054728,"volume":853},{"date":"2024-06-02","open":0.0701054728,"high":0.0728409233,"low":0.0515721347,"close":0.0597658679,"volume":765},{"date":"2024-06-09","open":0.0597658679,"high":0.0729528476,"low":0.0549932162,"close":0.057109869,"volume":471},{"date":"2024-06-16","open":0.057109869,"high":0.0590940963,"low":0.0453988439,"close":0.0466557067,"volume":372},{"date":"2024-06-23","open":0.0466557067,"high":0.0503929524,"low":0.0431256008,"close":0.0463234741,"volume":208},{"date":"2024-06-30","open":0.0463234741,"high":0.0525428479,"low":0.0449778596,"close":0.0454385834,"volume":184},{"date":"2024-07-07","open":0.0454385834,"high":0.0501212542,"low":0.0454385834,"close":0,"volume":98}];

const daily = [
  {"date":"2024-06-03","open":0.0597658679,"high":0.0597658679,"low":0.0549932162,"close":0.056513732,"volume":102},
  {"date":"2024-06-04","open":0.056513732,"high":0.0582417383,"low":0.0562464296,"close":0.0576120847,"volume":34},
  {"date":"2024-06-05","open":0.0576120847,"high":0.0676396253,"low":0.0574903116,"close":0.0676396253,"volume":121},
  {"date":"2024-06-06","open":0.0676396253,"high":0.0729528476,"low":0.0663368914,"close":0.0682795126,"volume":104},
  {"date":"2024-06-07","open":0.0682795126,"high":0.0688269677,"low":0.0620633124,"close":0.0630475536,"volume":39},
  {"date":"2024-06-08","open":0.0630475536,"high":0.0630475536,"low":0.0590308754,"close":0.0595847804,"volume":29},
  {"date":"2024-06-09","open":0.0595847804,"high":0.0600480039,"low":0.0564936983,"close":0.057109869,"volume":39},
  {"date":"2024-06-10","open":0.057109869,"high":0.0579334459,"low":0.0554916235,"close":0.0561527645,"volume":39},
  {"date":"2024-06-11","open":0.0561527645,"high":0.0561527645,"low":0.0546719744,"close":0.0547641969,"volume":22},
  {"date":"2024-06-12","open":0.0547641969,"high":0.0590940963,"low":0.0547641969,"close":0.0570201632,"volume":91},
  {"date":"2024-06-13","open":0.0570201632,"high":0.0570718115,"low":0.05274604,"close":0.05274604,"volume":44},
  {"date":"2024-06-14","open":0.05274604,"high":0.05274604,"low":0.0453988439,"close":0.0473314303,"volume":141},
  {"date":"2024-06-15","open":0.0473314303,"high":0.0483836826,"low":0.0468065595,"close":0.0483836826,"volume":12},
  {"date":"2024-06-16","open":0.0483836826,"high":0.0483836826,"low":0.0466557067,"close":0.0466557067,"volume":21},{"date":"2024-06-17","open":0.0466557067,"high":0.0466557067,"low":0.0443101481,"close":0.0451399639,"volume":25},{"date":"2024-06-18","open":0.0451399639,"high":0.0452723245,"low":0.0431256008,"close":0.0433773069,"volume":43},{"date":"2024-06-19","open":0.0433773069,"high":0.0467751196,"low":0.0433773069,"close":0.0464917674,"volume":29},{"date":"2024-06-20","open":0.0464917674,"high":0.0502599415,"low":0.0464917674,"close":0.0502340523,"volume":55},{"date":"2024-06-21","open":0.0502340523,"high":0.0503929524,"low":0.0484295302,"close":0.0484295302,"volume":14},{"date":"2024-06-22","open":0.0484295302,"high":0.0489167509,"low":0.047511638,"close":0.0475539549,"volume":17},{"date":"2024-06-23","open":0.0475539549,"high":0.0485089443,"low":0.0463234741,"close":0.0463234741,"volume":22},{"date":"2024-06-24","open":0.0463234741,"high":0.0475694996,"low":0.0449778596,"close":0.0449778596,"volume":20},{"date":"2024-06-25","open":0.0449778596,"high":0.0489786931,"low":0.0449778596,"close":0.0483929655,"volume":13},{"date":"2024-06-26","open":0.0483929655,"high":0.0483929655,"low":0.0463679121,"close":0.0463679121,"volume":2},{"date":"2024-06-27","open":null,"high":null,"low":null,"close":null,"volume":null},{"date":"2024-06-28","open":0.048496811,"high":0.0525428479,"low":0.048496811,"close":0.0511460377,"volume":25},{"date":"2024-06-29","open":0.0511460377,"high":0.0513249902,"low":0.0477502334,"close":0.0477502334,"volume":55},{"date":"2024-06-30","open":0.0477502334,"high":0.0477502334,"low":0.0452558957,"close":0.0454385834,"volume":38},{"date":"2024-07-01","open":0.0454385834,"high":0.0468491363,"low":0.0454385834,"close":0.0467510152,"volume":14},{"date":"2024-07-02","open":0.0467510152,"high":0.0501212542,"low":0.0467510152,"close":0.0479109251,"volume":69},
  {"date":"2024-07-03","open":0.0479109251,"high":0.05,"low":0.045,"close":0.0472368021,"volume":14}];

  // Data
const data = monthly;

const X = d3.map(data, (d) => d3.isoParse(d["date"]));

const Y = d3.map(data, (d) => {
  return {o: d.open, h: d.high, l: d.low, c: d.close, v: d.volume}
});

const minPrice = d3.min(d3.map(Y, d => d.l));
const maxPrice = d3.max(d3.map(Y, d => d.h));

// Colors
const COLORS = ["#1ebc8c", "#b2b2b2", "#f34d27"];

// Animations
const DURATION = 500;

// Layout
const margin = {
  top: 0,
  right: 15,
  bottom: 25,
  left: 45,
};

const svg = d3.select("#chart")
const width = +svg.attr("width");
const height = +svg.attr("height");
const innerHeight = height - margin.top - margin.bottom;
const innerWidth = width - margin.left - margin.right;

// Axes
const inner = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);

const domain = [minPrice, maxPrice];

const yLinear = d3.scaleLinear().domain(domain).range([innerHeight, 0]);
const yLog = d3.scaleLog().domain(domain).range([innerHeight, 0]);

const yAxis = d3.axisLeft(yLinear).tickSize(0);

const BAND_PADDING = 0.2;
const xScale = d3
  .scaleBand(X, [0, innerWidth])
  .paddingInner(BAND_PADDING)
  .align(0.5)
  .round(false);

const step = xScale.step();
const bandwidth = xScale.bandwidth();

function filterX(X, innerWidth, spacing) {
  const count = innerWidth / spacing;
  let interval = parseInt(X.length / count);
  if (interval < 1) interval = 1;
  return d3.filter(X, (d, i) => i % interval === 0);
}

const filteredX = filterX(X, innerWidth, 100);

const TIME_FORMAT = '%b %d, %Y';

const xAxis = d3
  .axisBottom(xScale)
  .tickValues(filteredX)
  .tickFormat(d3.timeFormat(TIME_FORMAT));

// const xAxis = d3.axisBottom(xScale).ticks(d3.timeMonth, 1).tickFormat(d3.timeFormat('%b'));

const yAxisElement = inner
  .append("g")
  .attr("class", "y axis")
  .attr("transform", `translate(0,0)`)
  .call(yAxis)
  .call((g) =>
    g
      .selectAll(".tick line")
      .clone()
      .attr("stroke", "#bbb") // Works for black or white background at 50% opacity
      .attr("stroke-opacity", 0.5)
      .attr("x1", BAND_PADDING * bandwidth)
      .attr("x2", innerWidth),
  );

const xAxisElement = inner
  .append("g")
  .attr("class", "x axis")
  .attr("transform", `translate(${BAND_PADDING * bandwidth},${margin.top + innerHeight})`)
  .call(xAxis)
  // .call((g) => g.select(".domain").remove());

// Candlesticks
const candlesticks = inner
  .append("g")
  .attr("stroke", "currentColor")
  .attr("stroke-linecap", "butt") // NOTE using 'square' distorts size
  .selectAll("g")
  .data(Y)
  .join("g")
  .attr("opacity", 1.0)
  .attr(
    "transform",
    (d, i) => `translate(${xScale(X[i]) + step / 2.0},0)`,
  );

function signOf(index) {
  return 1 + Math.sign(Y[index].o - Y[index].c);
}

const wicks = candlesticks.append("line")
  .attr("stroke", "currentColor")
  .attr("stroke-width", 1)
  .attr("opacity", 0.8)
  .attr("y1", yLinear(minPrice))
  .attr("y2", yLinear(minPrice))

wicks.transition()
  .duration(DURATION)
  .attr("y1", (d) => yLinear(d.l))
  .attr("y2", (d) => yLinear(d.h));

const bars = candlesticks.append("line")
  .attr("stroke-width", bandwidth)
  .attr("stroke", (d, i) => COLORS[signOf(i)])
  .attr("y1", yLinear(minPrice))
  .attr("y2", yLinear(minPrice))

bars.transition()
  .duration(DURATION)
  .attr("y1", (d) => yLinear(d.o))
  .attr("y2", (d) => yLinear(d.c))


// const g = svg
//       .append("g")
//       .attr("stroke", "currentColor")
//       .attr("stroke-linecap", "butt") // NOTE using 'square' distorts size
//       .selectAll("g")

function updateScaleY(newScale) {
  yAxisElement.transition()
    .duration(DURATION)
    .call(d3.axisLeft(newScale).tickSize(0));

  bars.transition()
    .duration(DURATION)
    .attr("y1", (d) => newScale(d.o))
    .attr("y2", (d) => newScale(d.c));

  wicks.transition()
    .duration(DURATION)
    .attr("y1", (d) => newScale(d.l))
    .attr("y2", (d) => newScale(d.h));
}

function updateScaleX(newX) {
  // To be fully dynamic, the new X scale needs to be defined here

  const xScaleZoom = d3
    .scaleBand(newX, [0, innerWidth])
    .paddingInner(BAND_PADDING)
    .align(0.5)
    .round(false);

  const filteredZoomX = filterX(newX, innerWidth, 120);
  
  const xAxisZoom = d3
    .axisBottom(xScaleZoom)
    .tickValues(filteredZoomX)
    .tickFormat(d3.timeFormat(TIME_FORMAT));

  // .append("g")
  // .attr("transform", `translate(${BAND_PADDING * bandwidth},${margin.top + innerHeight})`)
  // .call(xAxis)
  // .call((g) => g.select(".domain").remove());

  xAxisElement.transition()
    .duration(DURATION)
    .call(xAxisZoom)

  // Initial: xScale(X[i]) + step / 2.0
  const stepZoom = xScaleZoom.step();
  candlesticks.transition()
    .duration(DURATION)
    .attr("transform", (d, i) => `translate(${xScaleZoom(X[i]) + stepZoom / 2.0},0)`)
    .attr("opacity", (d, i) => xScaleZoom(X[i]) === undefined ? 0 : 1);

  bars.transition()
    .duration(DURATION)
    .attr("stroke-width", xScaleZoom.bandwidth());
}

function getRandomInt(max) {
  return Math.floor(Math.random() * max);
}


d3.select("#log").on("click", () => {
  updateScaleY(yLog);
});

d3.select("#linear").on("click", () => {
  updateScaleY(yLinear);
});

d3.select("#zoom").on("click", () => {
  console.log("ZOOM")

  // Get a random slice of the X values
  const start = getRandomInt(X.length);
  const length = getRandomInt(X.length - start);
  updateScaleX(X.slice(start, start + length));
});

d3.select("#original").on("click", () => {
  console.log("ORIGINAL")
  updateScaleX(X);
});
    </script>
  </body>
</html>


